---
title: Обновление до использования встроенного соединителя Common Data Service | Документация Майкрософт
description: ''
author: tapanm-msft
manager: kvivek
ms.service: powerapps
ms.topic: conceptual
ms.custom: canvas
ms.reviewer: ''
ms.date: 03/03/2020
ms.author: lanced
search.audienceType:
- maker
search.app:
- PowerApps
ms.openlocfilehash: e77bf1304ac7d1083348dce18d7d78189dfef306
ms.sourcegitcommit: 56c8c7cc64695ccb00e0d021c9f98cf70b69b4a2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2020
ms.locfileid: "78845383"
---
# <a name="common-data-service-and-the-improved-data-source-experience"></a>Common Data Service и Улучшенный интерфейс источников данных

## <a name="overview"></a>Обзор

Если вы создали приложение Canvas с соединителем Common Data Service до 2019 ноября, возможно, у вас не будет преимуществ самой последней версии Common Data Service. 

Параметр **улучшить взаимодействие с источником данных и Common Data Service представлений** имеет следующие преимущества.

1. Значительное увеличение скорости.
2. Повышенная надежность.
3. Доступ к Common Data Service **представлениям** и **атрибутам поля файла и изображения**.

Параметр **улучшение работы с источником данных и Common Data Service представлений** отображается в разделе Дополнительные параметры:

![Улучшение работы с источниками данных и представлениями Common Data Service](media/use-native-cds-connector/improved-data-source-setting.png)

**Реляционные данные, наборы параметров и другие новые функции для Common Data Service** теперь отображаются в разделе устаревшие компоненты.

## <a name="how-do-i-upgrade"></a>Разделы справки обновить?

Обновите приложение, изучив параметры компонентов, а затем в следующих направлениях:

### <a name="improve-data-source-experience-and-common-data-service-views-is-on"></a>*Улучшение работы с источниками данных и представлением Common Data Service* :

Вы уже преобразовали приложение Canvas для использования этой функции, или вы запустили приложение со значением по умолчанию *On* для этой функции. Дальнейшие действия не требуются. 

Также может потребоваться включить функцию **явного выбора столбцов** :

![Явный выбор столбцов](media/use-native-cds-connector/explicit-column-selection.png)

> [!NOTE]
> **Улучшение работы с источниками данных и представления Common Data Service** не поддерживается в [Power Apps для Windows](https://www.microsoft.com/p/power-apps/9nblggh5z8f3). Эту *функцию необходимо отключить при* использовании Power Apps для Windows.

### <a name="relational-data-option-sets-and-other-new-features-for-common-data-service-is-off"></a>*Реляционные данные, наборы параметров и другие новые функции для Common Data Service* отключены:

В разделе *Дополнительные параметры*проверьте раздел *устаревшие компоненты* .  Если задано значение *Off*, выполните следующие инструкции в качестве первого шага преобразования. 

> [!IMPORTANT]
> Если вы не видите **реляционные данные, наборы параметров и другие новые функции для Common Data Service** в *дополнительных параметрах*или если они уже *включены*, пропустите следующие шаги и перейдите к [следующему разделу](#improve-data-source-experience-and-common-data-service-views-is-off).

- **Шаг 1**. Включение функции " **отображаемые имена** " **в**:
    
    1. Включите функцию " **отображаемые имена** " *в*.
    1. Дождитесь завершения анализа приложения монитором работоспособности.
    1. Сохраните, закройте и снова откройте приложение.
    1. Устраните все ошибки в формулах.
    1. Сохраните, закройте и снова откройте приложение.
    
    *Возможные ошибки и предложения*:
    
    Возможно, некоторые из отображаемых имен могут конфликтовать с отображаемыми именами других сущностей, полей или элементов управления. Например, у вас может быть элемент управления и поле с тем же именем. Можно изменить имя элемента управления, указав уникальное значение для исправления.
    
    Для любого конфликта отображаемого имени поля и сущности может появиться формула, которая ожидает сущность, но разрешается в имя поля в локальной области.

    Используйте квадратную скобку с символом **@** , чтобы указать глобальную область, чтобы она была разрешаема в сущность. Например, **[@entityName]** .
    
    
- **Шаг 2**. Включение **реляционных данных, наборов параметров и других новых функций для Common Data Service** и **Использование типов данных GUID вместо строковых** функций **в**:
    
    1. Преобразуйте **реляционные данные, наборы параметров и другие новые функции для Common Data Service** функции *в*.
    1. Включите *в*функцию " **Использование типов данных GUID" вместо строк** .
    1. Дождитесь завершения анализа приложения монитором работоспособности.
    1. Устраните все ошибки в формулах.
    1. Сохраните, закройте и снова откройте приложение.  
    
    *Возможные ошибки и предложения*:
    
    На этом этапе могут возникнуть ошибки, если вы используете поле набора параметров или жестко запрограммированные текстовые значения GUID.  <br><br> 
    
    - *Значения набора параметров*: Если вы используете поле набора параметров с текстовым идентификатором для набора параметров, используйте точечную нотацию вместо ссылки на значение набора параметров. Например, измените `Patch(Accounts, OptionSet1 = “12345”)` на `Patch(Accounts, OptionSet.Item1)`, где `Item1` соответствует значению `12345`. <br>
    Дополнительные сведения см. в разделе " [подробные примеры](#detailed-examples) ".
    - *Идентификаторы GUID*: Если вы используете СТАТИЧЕСКУЮ строку GUID, например `015e45e1044e49f388115be07f2ee116`, преобразуйте ее в функцию, которая ВОЗВРАЩАЕТ объект GUID. например `GUID(“015e45e1044e49f388115be07f2ee116”)`. 
    - *Уточняющие запросы*. Если для получения значений первого уровня поиска, таких как `Lookup(Contacts, ‘contactID’ = ThisItem.ContactID”)`, используются функции поиска, рассмотрите возможность использования `ThisItem.PrimaryContacts` (где примариконтактс — это имя сущности).

### <a name="improve-data-source-experience-and-common-data-service-views-is-off"></a>*Улучшение работы с источниками данных и представления Common Data Service* отключены:

Используйте следующую инструкцию, чтобы включить функцию **улучшения работы с источниками данных и Common Data Service представлений** *на*:

1. Удалите существующие Common Data Service подключения к источникам данных. 
1. Включите *функцию* **улучшения работы с источниками данных и Common Data Service представлений** .
1. Добавьте Common Data Service подключение, используя новый интерфейс выбора источника данных.
1. Сохраните приложение.

> [!NOTE]
> Если приложение очень велико, Добавление подключений к источнику данных может занять некоторое время. Не закрывайте приложение во время этого процесса.

## <a name="converting-canvas-apps-with-the-dynamics-365-connector"></a>Преобразование приложений Canvas в соединитель Dynamics 365

Чтобы преобразовать приложение, использующее соединитель Dynamics 365, необходимо удалить и добавить подключения к источникам данных. Выполните приведенные ниже действия, чтобы преобразовать подключения к источникам данных.

1. Убедитесь, что функция **улучшения работы с источником данных и Common Data Service представлений** *включена.*
2. Удалите существующие подключения к источникам данных Dynamics 365.
3. Добавьте подключения к источникам данных в Common Data Service с помощью нового интерфейса выбора источника данных. 

    > [!NOTE] 
    > Если у вас есть подключения к другим средам (кроме текущего), выберите категорию *сущность* , а затем параметр *More* (...), чтобы изменить среду. Затем можно выбрать сущность из другой среды, чтобы добавить ее в приложение. Межклиентские соединения не работают с улучшенным собственным соединителем. Для доступа к данным между клиентами необходимо использовать интеграцию данных.
4.  Сохраните приложение.

*Возможные ошибки и предложения*:

Ошибки могут быть преобразованы, если вы не используете отображаемые имена, если используете строки GUID или если используется поле набора параметров.

- Если имя элемента управления конфликтует, измените имя элемента управления на другое и уникальное. 
- Для конфликтов имен полей и сущностей может отображаться формула, которая ожидает сущность, но разрешается в более локальное имя поля с областью действия. Используйте квадратную скобку с символом *@* , чтобы указать глобальную область, чтобы она была разрешаема в сущность. Например, **[@entityName]** .
- *Значения набора параметров*: Если вы используете поле набора параметров с текстовым идентификатором для набора параметров, используйте точечную нотацию вместо ссылки на значение набора параметров. Например, измените `Patch(Accounts, OptionSet1 = “12345”)` на `Patch(Accounts, OptionSet.Item1)`, где `Item1` соответствует значению `12345`. <br>
Дополнительные сведения см. в разделе " [подробные примеры](#detailed-examples) ".
- *Идентификаторы GUID*: Если используется СТАТИЧЕСКАЯ строка GUID, например `015e45e1044e49f388115be07f2ee116`, преобразуйте ее в функцию, которая ВОЗВРАЩАЕТ объект GUID; например `GUID(“015e45e1044e49f388115be07f2ee116”)`. 
- *Уточняющие запросы*. Если для получения значений первого уровня поиска, таких как `Lookup(Contacts, ‘contactID’ = ThisItem.ContactID”)`, используются функции поиска, рассмотрите возможность использования `ThisItem.PrimaryContacts` (где примариконтактс — это имя сущности).
- Сведения о любых полиморфизмных ссылках см. в разделе "подробные примеры" ниже. 

## <a name="detailed-examples"></a>Подробные примеры

Преобразование приложения для использования новых **наборов параметров** и двух типов данных **параметров** с помощью вспомогательных элементов управления может оказаться сложной задачей при обновлении приложения для использования новой *улучшенной функции работы с источниками данных и Common Data Service представлений* .

### <a name="option-sets"></a>Наборы параметров

Для параметра, установленного ранее, были использованы отдельные поля `_myfield` и `_myfield_label`. Теперь существует один `myfield`, который можно использовать как для независимых от языковых стандартов, так и для получения метки, зависящей от языкового стандарта.

#### <a name="removing-and-adding-option-set-data-cards"></a>Удаление и добавление карт данных наборов параметров

Рекомендуется удалить существующие карты данных и снова добавить их для работы с набором параметров. Например, если вы работаете с сущностью учетной записи и набором параметров Category, вы увидите, что свойство " *поле* данных" карточки Data имеет значение `_accountcategorycode_label`. В списке полей можно увидеть, что карточка данных имеет тип *строки*:

![Option с именем старого стиля](./media/use-native-cds-connector/OptionSet-with-old-style-name.png)

Благодаря новой *улучшенной функции работы с источниками данных и Common Data Service представлений* вы больше не видите `_accountcategorycode_label`. Он заменяется `accountcategorycode`. Карточка теперь помечена как **Настраиваемая** , и вы увидите ошибки. Удалите старую карточку данных и добавьте *параметр SET* Back. Новая карточка данных — *заданный параметр* учитывается.

![Option с именем старого стиля](./media/use-native-cds-connector/OptionSet-with-new-style-name.png)

#### <a name="editing-the-option-set-filter-expressions-to-use-new-syntax"></a>Изменение критериев фильтра Set для использования нового синтаксиса

Ранее, если вы хотите использовать значение набора параметров в критерии фильтра, необходимо использовать поле *значение* . Например:

```powerapps-dot
Filter(Account,'Category Value' = "1")
```

Эту формулу необходимо изменить. Параметр "задать текстовый идентификатор" больше не используется для этого значения. Это выражение должно быть обновлено для поиска следующих фрагментов:

```powerapps-dot
Filter(Account, Category= ‘Category (Accounts)’.’Preferred Customer’)
```

"Category (Accounts)" — это имя перечисления, используемое в поле Category сущности Accounts. Это локальный набор параметров.  Дополнительные сведения о локальных и глобальных наборах параметров можно узнать здесь: [глобальные наборы параметров.](https://docs.microsoft.com/powerapps/maker/common-data-service/create-edit-global-option-sets)

#### <a name="editing-option-set-patch-statements-to-use-new-syntax"></a>Изменение параметров SET Patch инструкции для использования нового синтаксиса

Ниже приведен пример более ранней инструкции patch для набора параметров.

```powerapps-dot
Patch( Accounts, First(Accounts), { ‘Category Value’: 1 } ) )
```

Вам потребуется обновить инструкции, чтобы они следовали следующей форме:

```powerapps-dot
Patch( Accounts, First(Accounts), { Category: ‘Category (Accounts)’.’Preferred Customer’ } )
```

#### <a name="option-set-disambiguation"></a>Установка параметра устранения неоднозначности

Если отображаемое имя **поля** набора параметров и имя набора параметров совпадают, необходимо устранить неоднозначность формулы. Чтобы продолжить использование примера кода категории Accounts, **@** предполагает использование набора параметров, а не поля.

```powerapps-dot
Filter(Accounts, 'Category Code' = [@’Category Code’].'Preferred Customer')
```

### <a name="two-options"></a>два варианта;

#### <a name="removing-and-adding-two-option-set-data-cards"></a>Удаление и добавление двух карт данных набора параметров

Следует удалить существующие карты данных и снова добавить их для работы с двумя наборами параметров. Типы данных ранее были распознаны как простые логические, такие как true/on и false/off без меток:

![Два набора параметров — старый стиль](./media/use-native-cds-connector/TwoOptionSet-Old.png)

Благодаря новой *улучшенной функции работы с источниками данных и Common Data Service представлений* карточка будет помечена как **Настраиваемая** , и вы увидите ошибки.  Удалите старую карточку данных и добавьте параметр SET Back. После добавления элемента управления изменением вы увидите два параметра по умолчанию.

![Твуптионсет — новый](./media/use-native-cds-connector/TwoOptionSet-New.png)

Если вы предпочитаете переключение логического поля, вы можете разблокировать карточку данных и заменить элемент управления в карточке данных на переключатель.  Также необходимо задать эти свойства в переключателе.

```powerapps-dot
Toggle1.Default = ThisItem.’Do not allow Bulk Emails’
Toggle1.TrueText = ‘Do not allow Bulk Emails (Accounts)’.’Do Not Allow’
Toggle1.FalseText = ‘Do not allow Bulk Emails (Accounts)’.Allow
DataCard.Value = If( Toggle1.Value,
    ‘Do not allow Bulk Emails (Accounts)’.’Do Not Allow’,
    ‘Do not allow Bulk Emails (Accounts)’.Allow )
```

![Два переключателя переключателя](./media/use-native-cds-connector/TwoOption-Toggle.png)

#### <a name="refining-two-option-patch-statements"></a>Уточнение двух инструкций исправлений

Использование функции [Patch](./functions/function-patch.md) с двумя вариантами должно работать "как есть". Он поддерживает прямое использование значений true и false, аналогично логическому. Единственная разница заключается в том, что если бы вы поместили значение в элемент управления Label раньше, что показало true и false, теперь вместо этого будут отображаться две метки параметров.

### <a name="polymorphic-lookups"></a>Уточняющие запросы с полиморфизмом

Ниже приведены рекомендации по обновлению приложения, если оно ссылается на поля с [преформациюми](working-with-references.md) . В этом же поле поддерживаются ссылки на ограниченный набор нескольких сущностей.  Как и ссылки на других языках, ссылка на запись — это указатель на определенную запись в определенной сущности. Ссылка на запись содержит сведения о сущности, позволяющие указывать на запись в нескольких разных сущностях, которые отличаются от обычного уточняющего запроса, который может указывать только на записи в одной сущности.  

#### <a name="access-set-and-filter-on-the-owner-field-of-a-record"></a>Доступ, установка и фильтрация в поле владельца записи

Например, поле "владелец" в сущности может ссылаться на запись в сущности "Пользователи" или в сущности "команды". Одно и то же поле поиска в разных записях может ссылаться на записи в разных сущностях.
 
![Поле с полиморфизмом](./media/use-native-cds-connector/Polymorphic1.png)
 
##### <a name="polymorphic-with-filter-and-patch"></a>Полиморфизм с фильтром и исправлением

Ссылки на записи можно использовать так же, как и полную запись:

```powerapps-dot
Filter( Accounts, Owner = First( Teams ) )
Patch( Accounts, First( Accounts ), { Owner: First( Users ) })
```

##### <a name="polymorphic-with-a-gallery-displaying-owner-name"></a>Преформацию с помощью коллекции, отображающей имя владельца

Так как ссылка может указывать на различные сущности, необходимо быть специальным. Нельзя использовать **ThisItem.Owner.Name**, так как поле имени в сущности **команды** является **именем группы**, а поле имени в сущности **пользователя** — **полным именем**. В приложениях Power Apps неизвестно, какой тип поиска вы ссылаетесь, пока приложение не будет запущено.

Чтобы устранить эту проблему: 

1. Добавьте источники данных для типов сущностей, которые могут быть владельцами. в текущем примере это пользователи и команды.
2. Используйте дополнительные функции, чтобы сделать свою цель понятной.

Существует две новые функции, которые можно использовать.

- Тип данных — проверяет, относится ли ссылка записи к конкретному типу сущности.
- Астипе — приводит ссылку на запись к конкретному типу сущности.

С помощью этих функций можно написать формулу, которая отображает имя владельца, взятого из двух полей с разными именами, в зависимости от типа сущности владельца:

```powerapps-dot
If( IsType( ThisItem.Owner,  [@Teams]), 
    AsType( ThisItem.Owner, [@Teams]).'Team Name', 
    AsType( ThisItem.Owner, [@Users]).'Full Name' )
```

![Коллекция с типом](./media/use-native-cds-connector/Polymorphic-And-AsType-in-Gallery.png)

Глобальный оператор однозначности для `[@Teams]` и `[@Users]` используется для обеспечения ссылки на глобальный тип сущности. Хотя в данном случае это необязательно, рекомендуется всегда быть ясным. Связи «один ко многим» часто конфликтуют в области записей галереи, и это не является путаницой.
 
#### <a name="access-and-set-the-company-name-field-a-customer-data-type-of-the-contacts-entity"></a>Доступ и задание поля "название компании" (тип данных Customer) сущности "Контакты"

Поле "Уточняющий запрос клиента" — еще один полиморфизм, похожий на "владелец". На одну сущность может быть только одно поле владельца. Однако сущность может включать в себя не более одного поля поиска клиента. Сущность «система контактов» включает в себя поле «Название компании», которое является полем подстановки клиента. Дополнительные сведения см. [в статье отображение полей клиента](https://docs.microsoft.com/powerapps/maker/canvas-apps/working-with-references#show-the-fields-of-a-customer) .
 
#### <a name="access-and-set-the-regarding-field-of-activity-entities-such-as-faxes-phone-calls-email-messages"></a>Доступ и установка поля "в отношении" сущностей действий, таких как факсы, телефонные звонки, сообщения электронной почты

Уточняющие запросы не ограничиваются учетными записями и контактами. Список сущностей может быть расширен с помощью пользовательских сущностей. Например, сущность «факсы» имеет в себе поле подстановки с преформациюм, которое может ссылаться на учетные записи, контакты и другие сущности. Если у вас есть коллекция, для которой источник данных имеет значение факсы, можно использовать следующую формулу для вывода имени, связанного с полем подстановки "в отношении". 
 
 ```powerapps-dot
If( IsBlank( ThisItem.Regarding ), "",
    IsType( ThisItem.Regarding, [@Accounts] ),
        "Account: " & AsType( ThisItem.Regarding, [@Accounts] ).'Account Name',
    IsType( ThisItem.Regarding, [@Contacts] ),
        "Contacts: " & AsType( ThisItem.Regarding, [@Contacts] ).'Full Name',
    "" )
```

![Коллекция с замечаниями](./media/use-native-cds-connector/Polymorphic-With-Regarding.png)
 
Дополнительные сведения см. в статье о [полях подстановки](https://docs.microsoft.com/powerapps/maker/canvas-apps/working-with-references#understand-regarding-lookup-fields) и о [связях](https://docs.microsoft.com/powerapps/maker/canvas-apps/working-with-references#understand-regarding-relationships) .

#### <a name="access-the-list-of-all-activities-for-a-record"></a>Доступ к списку всех действий для записи

В Common Data Service сущности, такие как факсы, задачи, сообщения электронной почты, заметки, телефонные звонки, письма и сеансы, обозначаются как [действия](https://docs.microsoft.com/powerapps/developer/common-data-service/activity-entities). Вы также можете создавать собственные [сущности настраиваемых действий](https://docs.microsoft.com/powerapps/developer/common-data-service/custom-activities).

Можно отобразить действия определенного типа (например, факсы или налоги) или все действия, связанные с сущностью, например учетной записью. Добавьте сущность действия и другие отдельные сущности, данные которых планируется отобразить в приложении Canvas.

Каждый раз, когда вы добавляете запись в (например, сущность Tasks), создается запись в сущности действия с полями, общими для всех сущностей действия. Чтение [сущности действия](https://docs.microsoft.com/powerapps/maker/canvas-apps/working-with-references#activity-entity) для получения дополнительных сведений.

В следующем примере показано, что при выборе учетной записи будут отображаться все действия, связанные с этой учетной записью:
 
![Полиморфизмы](./media/use-native-cds-connector/Polymorphic-Activities.png) 
 
Записи отображаются из сущности действия. Однако [функцию «Typ» можно](./functions/function-astype-istype.md) по-прежнему использовать для указания того, какой вид действия они представляют. Опять же, перед использованием типа данных Type с типом сущности необходимо добавить необходимый источник данных.
 
С помощью этой формулы можно отобразить тип записи в элементе управления Label в коллекции:

 ```powerapps-dot
If( IsType( ThisItem, [@Faxes] ), "Fax",
    IsType( ThisItem, [@'Phone Calls'] ), "Phone Call",
    IsType( ThisItem, [@'Email Messages'] ), "Email Message",
    IsType( ThisItem, [@Chats] ), "Chat",
    "Unknown")
```

 ![Полиморфизм-тип](./media/use-native-cds-connector/Polymorphic-IsType.png)

#### <a name="access-the-list-of-notes-for-a-record"></a>Доступ к списку заметок для записи

При создании сущности можно включить вложения. Если установить флажок для включения вложений, вы создадите связь с сущностью Notes, как показано на рисунке для сущности Accounts:

![Примечания — поле](./media/use-native-cds-connector/Notes-Field.png)

##### <a name="filtering"></a>Фильтрация

Чтение или фильтрация на основе поля "в отношении" невозможно. Однако доступна связь Обратная заметка один ко многим. Чтобы получить список всех примечаний, связанных с сущностью учетной записи, можно использовать следующую формулу:

```powerapps-dot
First( Accounts ).Notes
```

##### <a name="patch"></a>Исправление

Нельзя задать поле Notes в сущности с помощью обновления. Чтобы добавить запись в таблицу Notes сущности, можно использовать функцию Relate. Сначала создайте заметку, как в следующем примере:

```powerapps-dot
Relate( ThisItem.Notes, Patch( Notes, Defaults( Notes ), { Title: "A new note", isdocument:'Is Document (Notes)'.No } ) )
```

## <a name="next-steps"></a>Следующие шаги

- [Справочник формул](https://docs.microsoft.com/powerapps/maker/canvas-apps/formula-reference)
- [Справочник элементов управления](https://docs.microsoft.com/powerapps/maker/canvas-apps/reference-properties)

### <a name="see-also"></a>См. также:

[Что такое Common Data Service?](https://docs.microsoft.com/powerapps/maker/common-data-service/data-platform-intro)
